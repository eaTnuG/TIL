## ORM과 영속성

### ORM 

Object Relational Mapping. 말 그대로 객체와 관계를 대응시켜주는 것이다. 어떤 데이터를 다룰때, 객체지향 프로그래밍에서는 클래스를 관계형 데이터베이스에서는 에티블을 사용한다. 이때 각각이 사용하는 객체 모델과 관계형 모델간의 불일치를 핸들링해주는 것이 ORM 이다. 둘의 차이를 모두 알고 있는 상태에서 이를 고려해 SQL을 생성해주고, 오브젝트를 사용할 수 있게 해준다. 그런데 이를 persistant api 라고도 한다... 왜? 

ORM을 사용하면

- 객체지항적 코드로 데이터베이스를 관리할 수 있고,
- 재사용 및 유지보수의 편리성이 증가하며
- DBMS에 대한 종속성이 줄어든다.

하지만

- ORM으로만 서비스를 구현하기는 어려우며,
- 프로시저가 많은 시스템에서는 ORM의 '객체지항젹인 장점'? 을 활용하기 어렵다.


### 영속성

영속성이란 말 그대로 '유지되는 것'을 의미한다. 일반적인 프로그램에서 다루는 데이터는 메모리에 저장되고 프로그램이 종료되면 사라지기 때문에, 영속성을 갖지 못한다. 이때 이러한 데이터에게 영속성을 부여해 주는 방법으로 SQL Mapper와  ORM이 있다.

JPA를 기준으로 영속성에 대해 알아보자. JPA는 자바진영에서의 ORM 표준 인터페이스 스펙( 실제 구현체로는 hibernate가 있음 )이라고 보면 된다. 

JPA의 핵심 내용은 `영속성 컨텍스트`에 포함되어 있냐 아니냐로 갈린다. JPA의 엔티티 매니저가 활성화된 상태로 트랜잭션안에서 DB에서 데이터를 가져오면 이 데이터는 `영속성 컨텍스트`가 유지된 상태이다. 이 `영속성 컨텍스트` 라는건 엔티티를 담고 있는 집합이라고 보면 된다. JPA가 이 엔티티의 내용을 DB에 반영하는 것이다.

영속성 컨텍스트의 관점에서 엔티티의 4가지 상태를 알아보자.

- 비영속: 엔티티 객체가 만들어져서 아직 저장되지 않은 상태. 영속성 컨텍스트와 관계가 없는 상태
- 영속: 엔티티가 영속성 컨텍스트에 저장되어, 영속성 컨텍스트가 관리할 수 있는 상태
- 준영속: 엔티티가 영속성 컨텍스트에 저장되어 있다가 분리된 상태로, 영속성 컨텍스트가 더이상 관리하지 않는 상태
- 삭제: 엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제한 상태

영속성 컨텍스트는 엔티티를 식별자 값(테이블의 기본키와 매핑된 필드)으로 구분한다. 그렇기 때무네 영속 상태는 식별자 값을 반드시 가진다.

영속성 컨텍스트에 엔티티를 저장하면 바로 데이터베이스에 저장되는 것이 아니라, 1차 캐시에 엔티티를 생성하고, 쓰기 지연 SQL 저장소에 쿼리문을 생성해서 저장한다. 이렇게 쌓인 쿼리문은 flush가 실해오딜 때 데이터베이스에 반영된다. 언제 캐시가 생기고 언제 flush 되는가...


>> 1차 캐시 === 영속성 컨텍스트?
>> 영속성 컨텍스트를 사용하는 이유 캐시? 롤백??

### 번외) Repository, Entity, DAO, DTO, VO, 

- Repository ( DAO ): 실제로 DB에 접근하는 객체이다. Service와 DB를 연결하는 고리의 역할을 한다. 
- DTO (VO): 계층간 데이터 교환을 위한 객체. DB에서 얻어온 객체를 다른 레이어로 전달할 때 사용하는 객체. 별다른 로직없이 순수한 데이터만 가지는 객체. read only로 사용되는 경우 VO라고 한다.
- Entity: 실제 DB의 테이블과 매칭되는 클래스. 외부에서 별다른 작업 없이 기능할 수 있도록 인터페이스를 설계해야한다?. Entity는 테이블의 로우라고 보면 Repository는 테이블이라고 보면 된다.


### REF

- https://gmlwjd9405.github.io/2019/02/01/orm.html
- https://velog.io/@modsiw/JPAJava-Persistence-API%EC%9D%98-%EA%B0%9C%EB%85%90
- https://velog.io/@tmdgusya/Entity-Manager
- https://eastflag.co.kr/nodejs/rest-with-nodejs/typeorm-%EC%84%A4%EC%A0%95/
- https://gmlwjd9405.github.io/2018/12/25/difference-dao-dto-entity.html
- https://stackoverflow.com/questions/20911383/entity-vs-repository-whats-the-difference
- https://velog.io/@agugu95/%EC%8A%A4%ED%94%84%EB%A7%81-%ED%8C%A8%ED%84%B4%EA%B3%BC-DAO-DTO-Repository
- https://gmlwjd9405.github.io/2019/08/06/persistence-context.html